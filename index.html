<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nh·∫≠t k√Ω c√¥ng vi·ªác</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 20px auto; padding: 10px; }
    h1 { text-align: center; }
    label { display: block; margin-top: 10px; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; }
    textarea { resize: vertical; }
    button { margin-top: 10px; padding: 10px 15px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
  </style>
</head>
<body>
  <h1>Nh·∫≠t k√Ω c√¥ng vi·ªác</h1>
  <form id="logForm">
    <label>Nh√¢n vi√™n:
      <input type="text" id="employee" required>
    </label>
    <label>D·ª± √°n:
      <input type="text" id="project" required>
    </label>
    <label>Ng√†y:
      <input type="date" id="date" required>
    </label>
    <label>Gi·ªù b·∫Øt ƒë·∫ßu:
      <input type="time" id="start" required>
    </label>
    <label>Gi·ªù k·∫øt th√∫c:
      <input type="time" id="end" required>
    </label>
    <label>N·ªôi dung c√¥ng vi·ªác:
      <textarea id="taskDetail" rows="3" required></textarea>
    </label>
    <button type="submit">Th√™m nh·∫≠t k√Ω</button>
  </form>

  <label>L·ªçc theo nh√¢n vi√™n:
    <input type="text" id="filterEmployee" placeholder="Nh·∫≠p t√™n nh√¢n vi√™n ƒë·ªÉ l·ªçc">
  </label>
  <label>L·ªçc theo d·ª± √°n:
    <input type="text" id="filterProject" placeholder="Nh·∫≠p t√™n d·ª± √°n ƒë·ªÉ l·ªçc">
  </label>
  <label>L·ªçc t·ª´ ng√†y:
    <input type="date" id="filterFrom">
  </label>
  <label>L·ªçc ƒë·∫øn ng√†y:
    <input type="date" id="filterTo">
  </label>
  <label>L·ªçc theo gi·ªù b·∫Øt ƒë·∫ßu:
    <input type="time" id="filterStart">
  </label>
  <label>L·ªçc theo gi·ªù k·∫øt th√∫c:
    <input type="time" id="filterEnd">
  </label>
  <label>L·ªçc theo n·ªôi dung c√¥ng vi·ªác:
    <input type="text" id="filterTask" placeholder="T·ª´ kh√≥a n·ªôi dung c√¥ng vi·ªác">
  </label>

  <button onclick="exportExcel()">üì§ Xu·∫•t Excel</button>

  <h2>Danh s√°ch c√¥ng vi·ªác</h2>
  <table id="logTable">
    <thead>
      <tr>
        <th>Nh√¢n vi√™n</th>
        <th>D·ª± √°n</th>
        <th>Ng√†y</th>
        <th>B·∫Øt ƒë·∫ßu</th>
        <th>K·∫øt th√∫c</th>
        <th>S·ªë gi·ªù</th>
        <th>N·ªôi dung c√¥ng vi·ªác</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>T·ªïng s·ªë gi·ªù theo d·ª± √°n</h2>
  <ul id="summary"></ul>

  <h2>T·ªïng s·ªë gi·ªù theo nh√¢n vi√™n</h2>
  <ul id="employeeSummary"></ul>

  <script>
    const form = document.getElementById('logForm');
    const tableBody = document.querySelector('#logTable tbody');
    const summary = document.getElementById('summary');
    const employeeSummary = document.getElementById('employeeSummary');
    const filterInput = document.getElementById('filterEmployee');
    const filterProject = document.getElementById('filterProject');
    const filterFrom = document.getElementById('filterFrom');
    const filterTo = document.getElementById('filterTo');
    const filterStart = document.getElementById('filterStart');
    const filterEnd = document.getElementById('filterEnd');
    const filterTask = document.getElementById('filterTask');

    const endpoint = 'https://script.google.com/macros/s/AKfycbzOX5NJ1cDJhsO15PVqK65b-_heLXQxmEJdU5wX2MT-g4csoMaLRqnzoHnJIW575n1jkA/exec';

    let logs = [];

    async function fetchLogs() {
      try {
        const res = await fetch(endpoint);
        logs = await res.json();
        renderLogs();
      } catch (err) {
        alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ Google Sheet');
      }
    }

    function calcHours(start, end) {
      const [h1, m1] = start.split(':').map(Number);
      const [h2, m2] = end.split(':').map(Number);
      return ((h2 * 60 + m2) - (h1 * 60 + m1)) / 60;
    }

    function renderLogs() {
      tableBody.innerHTML = '';
      const projectTotals = {};
      const employeeTotals = {};

      const filterName = filterInput.value.trim().toLowerCase();
      const projectName = filterProject.value.trim().toLowerCase();
      const fromDate = filterFrom.value;
      const toDate = filterTo.value;
      const startTime = filterStart.value;
      const endTime = filterEnd.value;
      const taskKeyword = filterTask.value.trim().toLowerCase();

      logs.forEach(log => {
        const hours = calcHours(log.start, log.end);

        if (filterName && !log.employee.toLowerCase().includes(filterName)) return;
        if (projectName && !log.project.toLowerCase().includes(projectName)) return;
        if (fromDate && log.date < fromDate) return;
        if (toDate && log.date > toDate) return;
        if (startTime && log.start < startTime) return;
        if (endTime && log.end > endTime) return;
        if (taskKeyword && !log.taskDetail.toLowerCase().includes(taskKeyword)) return;

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${log.employee}</td>
          <td>${log.project}</td>
          <td>${log.date}</td>
          <td>${log.start}</td>
          <td>${log.end}</td>
          <td>${hours.toFixed(2)}</td>
          <td>${log.taskDetail}</td>
        `;
        tableBody.appendChild(row);

        projectTotals[log.project] = (projectTotals[log.project] || 0) + hours;
        employeeTotals[log.employee] = (employeeTotals[log.employee] || 0) + hours;
      });

      summary.innerHTML = '';
      for (const [project, total] of Object.entries(projectTotals)) {
        const li = document.createElement('li');
        li.textContent = `${project}: ${total.toFixed(2)} gi·ªù`;
        summary.appendChild(li);
      }

      employeeSummary.innerHTML = '';
      for (const [employee, total] of Object.entries(employeeTotals)) {
        const li = document.createElement('li');
        li.textContent = `${employee}: ${total.toFixed(2)} gi·ªù`;
        employeeSummary.appendChild(li);
      }
    }

    async function exportExcel() {
      const filterName = filterInput.value.trim().toLowerCase();
      const projectName = filterProject.value.trim().toLowerCase();
      const fromDate = filterFrom.value;
      const toDate = filterTo.value;
      const startTime = filterStart.value;
      const endTime = filterEnd.value;
      const taskKeyword = filterTask.value.trim().toLowerCase();

      const data = logs.filter(log => {
        if (filterName && !log.employee.toLowerCase().includes(filterName)) return false;
        if (projectName && !log.project.toLowerCase().includes(projectName)) return false;
        if (fromDate && log.date < fromDate) return false;
        if (toDate && log.date > toDate) return false;
        if (startTime && log.start < startTime) return false;
        if (endTime && log.end > endTime) return false;
        if (taskKeyword && !log.taskDetail.toLowerCase().includes(taskKeyword)) return false;
        return true;
      }).map(log => ({
        'Nh√¢n vi√™n': log.employee,
        'D·ª± √°n': log.project,
        'Ng√†y': log.date,
        'B·∫Øt ƒë·∫ßu': log.start,
        'K·∫øt th√∫c': log.end,
        'S·ªë gi·ªù': calcHours(log.start, log.end).toFixed(2),
        'N·ªôi dung c√¥ng vi·ªác': log.taskDetail
      }));

      const worksheet = XLSX.utils.json_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'NhatKy');
      XLSX.writeFile(workbook, 'nhat_ky_cong_viec.xlsx');
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const log = {
        employee: document.getElementById('employee').value,
        project: document.getElementById('project').value,
        date: document.getElementById('date').value,
        start: document.getElementById('start').value,
        end: document.getElementById('end').value,
        taskDetail: document.getElementById('taskDetail').value
      };

      try {
        await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(log)
        });
        await fetchLogs();
        form.reset();
      } catch (err) {
        alert('L·ªói khi g·ª≠i d·ªØ li·ªáu l√™n Google Sheet');
      }
    });

    [filterInput, filterProject, filterFrom, filterTo, filterStart, filterEnd, filterTask].forEach(input => {
      input.addEventListener('input', renderLogs);
      input.addEventListener('change', renderLogs);
    });

    fetchLogs();
  </script>
</body>
</html>
